<link rel="stylesheet" href="https://cdn.fluidplayer.com/v2/current/fluidplayer.min.css" type="text/css" />
<script src="fluidplayer.js"></script>
<style>
    .fluid_video_wrapper {
        -webkit-transition: width 3s, height 3s, margin 3s;
        /* Safari */
        transition: width 3s, height 3s, margin 3s;
    }
</style>

<div class="wrapper" id="wrapper" style="width:970px;height:550px;">
    <video id="video-id">
        <source src="https://iab-publicfiles.s3.amazonaws.com/vast/VAST-4.0-Short-Intro.mp4" type="video/mp4" />
    </video>
</div>

<script>
    var firstPlay = true
    var completedTransition = false
    var completedAd = false

    var width = "970px"
    var height = "550px"

    var newWidth = "640px"
    var newHeight = "360px"

    var marginTop = "60px"

    var destroyPlayer = function (idVideoPlayer) {
        document.getElementById('fluid_video_wrapper_' + idVideoPlayer).remove();
        for (var i = 0; i < fluidPlayerClass.instances.length; i++) {
            if (fluidPlayerClass.instances[i].videoPlayerId === idVideoPlayer) {
                var videoWrapper = document.getElementById('fluid_video_wrapper_' + idVideoPlayer);
                var oldPlayer = document.getElementById(idVideoPlayer);
                var newPlayer = oldPlayer.cloneNode(true);
                videoWrapper.innerHTML = '';
                newPlayer.removeAttribute('src');
                videoWrapper.parentNode.replaceChild(newPlayer, videoWrapper);
                videoWrapper = null;
                oldPlayer = null;

                //Kill instance
                fluidPlayerClass.instances[i] = {
                    videoPlayerId: '83748374hjkehwkfjrweqh8724983278983k'
                };

                break;
            }
        }
    };

    var hidePlayerButtons = function () {
        var hide = "display:none"

        var fullscreen = document.getElementById('video-id_fluid_control_fullscreen')
        fullscreen.style = hide
        var theatre = document.getElementById('video-id_fluid_control_theatre')
        theatre.style = hide
        var progress = document.getElementById('video-id_fluid_control_duration')
        progress.style = hide
    }

    var showPlayerButtons = function () {
        var show = "display:block"

        var fullscreen = document.getElementById('video-id_fluid_control_fullscreen')
        fullscreen.style = show
        var theatre = document.getElementById('video-id_fluid_control_theatre')
        theatre.style = show
        var progress = document.getElementById('video-id_fluid_control_duration')
        progress.style = show
    }

    var removeAllListener = function () {
        wrapper.removeEventListener("mouseleave", playerOut)
        wrapper.removeEventListener("mouseenter", playerIn)
    }

    var playerOut = function () {
        var video_wrapper = document.getElementById('fluid_video_wrapper_video-id')
        // si no ha terminado la transicion, vuelve al tamaño inicial
        if (!completedTransition) {
            video_wrapper.style.width = width
            video_wrapper.style.height = height
            video_wrapper.style.marginTop = "0px"
        }
    }

    var playerIn = function () {
        var video_wrapper = document.getElementById('fluid_video_wrapper_video-id')
        video_wrapper.style.width = newWidth
        video_wrapper.style.height = newHeight
        video_wrapper.style.marginTop = marginTop
    }

    var options = {
        vastOptions: {
            /*adList: [{
                roll: "preRoll",
                vastTag: "vast.xml",
                adClickable: false
            }]*/
            vastAdvanced: {
                vastLoadedCallback: (function () {
                    // quitamos los botones que no necesitamos
                    hidePlayerButtons()
                }),
                noVastVideoCallback: (function () {}),
                vastVideoSkippedCallback: (function () {}),
                vastVideoEndedCallback: (function () {
                    var video_wrapper = document.getElementById('fluid_video_wrapper_video-id')
                    video_wrapper.style = "position: absolute;width: " + newWidth + ";height: " + newHeight + ";"
                    completedAd = true
                    /* if (completedTransition) {
                         destroyPlayer('video-id')
                         resetPlayer()
                     } else {
                         removeAllListener()
                         showPlayerButtons()
                         completedAd = true
                     }*/
                })
            }
        },
        layoutControls: {
            autoPlay: false
        },
        layoutControls: {
            playerInitCallback: (function () {
                // obtenemos el contenedor del reproductor
                var video_wrapper = document.getElementById('fluid_video_wrapper_video-id')

                // si el reproductor ya se achicó en el siguiente bucle mantendra el tamaño
                if (!completedTransition) {
                    video_wrapper.style = "position: absolute;width: " + width +";height: " + height + ";"
                } else {
                    video_wrapper.style = "position: absolute;width: " + newWidth + ";height: " + newHeight + ";"
                }

                // si el primer bucle, agregamos el HTML del fondo
                if (firstPlay) {
                    var background = document.createElement('div')
                    background.style = "background:gray;width:" + width +";height:" + height + ""
                    wrapper.appendChild(background)
                }

                // agregamos el listener para cuando termine de achicarse
                video_wrapper.addEventListener("transitionend", function (event) {
                    if (event.propertyName === "width") {
                        if (event.elapsedTime > 2.8) {
                            completedTransition = true
                        }
                    }
                });

                // agregamos el listener para cuando el mouse salga del reproductor
                wrapper.addEventListener("mouseleave", playerOut)

                firstPlay = false
            })
        }
    }

    var video = fluidPlayer("video-id", options);

    var resetPlayer = function () {
        // iniciamos una nueva instancia del reproductor
        fluidPlayer('video-id', options);
    };

    video.on('play', function () {
        if (!completedAd) {
            var video_wrapper = document.getElementById('fluid_video_wrapper_video-id')
            // agregamos el listener para cuando el mouse este dentro de reproductor
            wrapper.addEventListener("mouseenter", playerIn);
        }
    })

    video.on('ended', function(){
        removeAllListener();
        playerIn();
    })
</script>